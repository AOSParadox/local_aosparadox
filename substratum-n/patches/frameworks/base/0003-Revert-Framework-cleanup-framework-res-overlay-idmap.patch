From 1aa69e8e11da0047dbd44f15271ec71a5fa72929 Mon Sep 17 00:00:00 2001
From: Louis Popi <theh2o64@gmail.com>
Date: Sat, 28 Jan 2017 11:36:57 +0100
Subject: [PATCH 03/35] Revert "Framework:cleanup framework res-overlay/idmap
 fd"

This reverts commit c1fd64b3838e0b48ee56428599d0dcc7ff4842a9.
---
 include/androidfw/AssetManager.h |  2 +-
 libs/androidfw/AssetManager.cpp  | 22 ----------------------
 2 files changed, 1 insertion(+), 23 deletions(-)

diff --git a/include/androidfw/AssetManager.h b/include/androidfw/AssetManager.h
index 2d5f4c2..914ac3d 100644
--- a/include/androidfw/AssetManager.h
+++ b/include/androidfw/AssetManager.h
@@ -359,7 +359,7 @@ private:
 
         void addOverlay(const String8& path, const asset_path& overlay);
         bool getOverlay(const String8& path, size_t idx, asset_path* out) const;
-        void closeZipFromPath(const String8& zip);
+        
     private:
         void closeZip(int idx);
 
diff --git a/libs/androidfw/AssetManager.cpp b/libs/androidfw/AssetManager.cpp
index d5f2666..6ed788d 100644
--- a/libs/androidfw/AssetManager.cpp
+++ b/libs/androidfw/AssetManager.cpp
@@ -804,13 +804,7 @@ void AssetManager::addSystemOverlays(const char* pathOverlaysList,
             sharedRes->add(oass, oidmap, offset + 1, false);
             const_cast<AssetManager*>(this)->mAssetPaths.add(oap);
             const_cast<AssetManager*>(this)->mZipSet.addOverlay(targetPackagePath, oap);
-            delete oidmap;
        }
-
-        if (oap.path.find(OVERLAY_DIR) != -1) {
-           const_cast<AssetManager*>(this)->mZipSet.closeZipFromPath(oap.path);
-           ALOGD("close: %s and reset entry\n", oap.path.string());
-      }
   }
 
 #ifndef _WIN32
@@ -2012,22 +2006,6 @@ AssetManager::ZipSet::~ZipSet(void)
 }
 
 /*
- * Close a Zip file from path and reset the entry
- */
-void AssetManager::ZipSet::closeZipFromPath(const String8& zip)
-{
-    //close zip fd
-    int fd = getZip(zip)->getFileDescriptor();
-
-    if (fd > 0) {
-        close(fd);
-        //reset zip object and entry
-        int idx = getIndex(zip);
-        mZipFile.editItemAt(idx) = NULL;
-    }
-}
-
-/*
  * Close a Zip file and reset the entry.
  */
 void AssetManager::ZipSet::closeZip(int idx)
-- 
2.7.4

